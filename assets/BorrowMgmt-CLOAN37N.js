import{r as i,j as t,g as M}from"./index-Cm4EQLYg.js";import{s as l,u as d,a as c}from"./toastUpdating-DHdby-RR.js";const Q=()=>{const[o,T]=i.useState(null),[h,u]=i.useState({moTa:"",hinhThucXuLy:"",tienPhat:0}),[I,f]=i.useState(!1),[$,k]=i.useState([]),[B,y]=i.useState(null),[b,N]=i.useState([]),[C,V]=i.useState(""),[m,w]=i.useState(null),[D,E]=i.useState(1),[p,L]=i.useState(1),[X,H]=i.useState(0);console.log(X);const[x,v]=i.useState(1);i.useEffect(()=>{p!==x&&L(x),g()},[x,m]);const g=async()=>{let e;setTimeout(()=>{e=l("Đang tải phiếu mượn...")},0);try{const a=new URLSearchParams;C&&a.append("sdt",C),m!==null&&a.append("daTraHet",String(m)),a.append("page",x.toString());const n=await fetch(`https://qltv-be-r6rg.onrender.com/phieuMuon/getAll?${a.toString()}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}});if(n.ok){const s=await n.json();N(s.data),E(s.totalPages||1),L(s.currentPage||1),H(s.totalItems||0),d(e,"Tải phiếu mượn xong!")}else{const s=await n.text();c(e,s)}}catch(a){c(e,"Không kết nối được đến máy chủ..."),console.error("Fetch error:",a)}},A=()=>{v(1),g()},q=()=>{x>1&&v(e=>e-1)},z=()=>{v(e=>e+1)},O=async e=>{const a=l("Đang xoá phiếu mượn...");try{const n=await fetch(`https://qltv-be-r6rg.onrender.com/phieuMuon/delete/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}});if(n.ok)d(a,"Xoá phiếu mượn thành công!"),await g(),N(s=>s.filter(r=>r.id!==e)),y(null);else{const s=await n.text();c(a,s)}}catch(n){c(a,"Lỗi máy chủ"),console.error("Lỗi khi xoá:",n)}},S=async e=>{const a=l("Đang tải chi tiết phiếu mượn...");try{const n=await fetch(`https://qltv-be-r6rg.onrender.com/ChiTietPhieuMuon/get/${e}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}});if(n.ok){const r=(await n.json()).map(j=>({...j,idPhieuMuon:e}));k(r),f(!0),d(a,"Tải chi tiết phiếu mượn xong!")}else{const s=await n.text();c(a,s)}}catch(n){c(a,"Lỗi máy chủ"),console.error("Lỗi khi lấy chi tiết phiếu mượn:",n)}},F=async(e,a)=>{const n=l("Đang xác nhận trả sách...");try{const s=await fetch(`https://qltv-be-r6rg.onrender.com/ChiTietPhieuMuon/traSach/${e}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}});if(s.ok)T(null),k(r=>r.map(j=>j.idCTPM===e?{...j,ngayTraThucTe:new Date().toISOString()}:j)),d(n,"Trả sách thành công!"),g(),await S(a);else{const r=await s.text();c(n,r)}}catch(s){c(n,"Không kết nối được đến máy chủ"),console.error("Lỗi xác nhận trả sách:",s)}},G=async(e,a)=>{await M("Bạn có chắc muốn thực hiện hành động này!")&&await F(e,a)},P=async e=>{if(!o)return;const a=l("Đang lấy loại vi phạm...");try{const n=await fetch(`https://qltv-be-r6rg.onrender.com/viPham/getPhatMacDinh?&loaiViPham=${encodeURIComponent(e)}&idCTPM=${o.idCTPM}`,{method:"GET",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(n.ok){const s=await n.json();u(s),d(a,"Lấy loại vi phạm thành công!")}else{const s=await n.text();c(a,s)}}catch(n){c(a,"Lỗi máy chủ"),console.error("Lỗi khi lấy phạt mặc định:",n)}},K=async()=>{if(!o)return;const e={chiTietPhieuMuonId:o.idCTPM,moTa:h.moTa,hinhThucXuLy:h.hinhThucXuLy,tienPhat:h.tienPhat},a=l("Đang thêm vi phạm...");try{const n=await fetch("https://qltv-be-r6rg.onrender.com/viPham/createViPham",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(e)});if(n.ok)T(null),u({moTa:"",hinhThucXuLy:"",tienPhat:0}),d(a,"Thêm vi phạm thành công!"),g(),S(o.idPhieuMuon);else{const s=await n.text();c(a,s)}}catch(n){c(a,"Lỗi máy chủ"),console.error("Lỗi khi thêm vi phạm:",n)}},R=async()=>{await M("Bạn có chắc muốn thực hiện hành động này!")&&await K()};return t.jsxs("div",{className:"borrow-mgmt-container",children:[t.jsx("h1",{className:"title",children:"Quản lý phiếu mượn"}),t.jsxs("div",{className:"toolbar",children:[t.jsxs("div",{className:"filter-buttons",children:[t.jsx("button",{className:`filter-button ${m===!0?"active":""}`,onClick:()=>w(e=>e===!0?null:!0),children:"Đã trả hết"}),t.jsx("button",{className:`filter-button ${m===!1?"active":""}`,onClick:()=>w(e=>e===!1?null:!1),children:"Chưa trả hết"})]}),t.jsxs("div",{className:"search-box",children:[t.jsx("input",{type:"text",placeholder:"Tìm số điện thoại...",value:C,onChange:e=>V(e.target.value)}),t.jsx("button",{className:"search-button",onClick:A,children:"Tìm kiếm"})]})]}),t.jsxs("table",{className:"borrow-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"ID"}),t.jsx("th",{children:"SĐT"}),t.jsx("th",{children:"Ngày mượn"}),t.jsx("th",{children:"Tổng tiền mượn"}),t.jsx("th",{children:"Tiền cọc còn lại"}),t.jsx("th",{children:"Hành động"})]})}),t.jsx("tbody",{children:b&&b.length>0?b.map(e=>t.jsxs("tr",{children:[t.jsx("td",{children:e.id}),t.jsx("td",{children:e.sdt}),t.jsx("td",{children:e.ngayMuon}),t.jsxs("td",{children:[(e.tongTienMuon*1e3).toLocaleString("vi-VN"),"đ"]}),t.jsxs("td",{children:[(e.tienCocConLai*1e3).toLocaleString("vi-VN"),"đ"]}),t.jsx("td",{children:B===e.id?t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"action-btn",onClick:()=>O(e.id),children:"Xác nhận xoá"}),t.jsx("button",{className:"action-btn delete",onClick:()=>y(null),children:"Huỷ"})]}):t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"action-btn",onClick:()=>S(e.id),children:"Chi tiết"}),t.jsx("button",{className:"action-btn delete",onClick:()=>y(e.id),children:"Xoá"})]})})]},e.id)):t.jsx("tr",{children:t.jsx("td",{colSpan:6,className:"no-data",children:"Không có dữ liệu"})})})]}),t.jsxs("div",{className:"pagination-user",children:[t.jsx("button",{onClick:q,disabled:p===1,children:"Trang trước"}),t.jsxs("span",{children:["Trang ",p," / ",D]}),t.jsx("button",{onClick:z,disabled:p>=D,children:"Trang sau"})]}),I&&t.jsx("div",{className:"overlay-bookmgmt",children:t.jsxs("div",{className:"overlay-content",children:[t.jsx("h2",{children:"Chi tiết phiếu mượn"}),t.jsxs("table",{className:"overlay-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"ID CTPM"}),t.jsx("th",{children:"ID Sách Cá Biệt"}),t.jsx("th",{children:"Tên sách"}),t.jsx("th",{children:"Ngày trả"}),t.jsx("th",{children:"Ngày trả thực tế"}),t.jsx("th",{children:"Tiền mượn"}),t.jsx("th",{children:"Tiền cọc"}),t.jsx("th",{children:"Tiền phạt"}),t.jsx("th",{children:"Tiền trả lại"}),t.jsx("th",{children:"Hành động"})]})}),t.jsx("tbody",{children:$.map(e=>t.jsxs("tr",{children:[t.jsx("td",{children:e.idCTPM}),t.jsx("td",{children:e.idSachCaBiet}),t.jsx("td",{children:e.tenSach}),t.jsx("td",{children:e.ngayTra}),t.jsx("td",{children:e.ngayTraThucTe}),t.jsxs("td",{children:[(e.tienMuon*1e3).toLocaleString("vi-VN"),"đ"]}),t.jsxs("td",{children:[(e.tienCoc*1e3).toLocaleString("vi-VN"),"đ"]}),t.jsxs("td",{children:[(e.tienPhat*1e3).toLocaleString("vi-VN"),"đ"]}),t.jsxs("td",{children:[(e.tienTraLai*1e3).toLocaleString("vi-VN"),"đ"]}),t.jsxs("td",{children:[t.jsx("button",{className:"action-btn",onClick:()=>G(e.idCTPM,e.idPhieuMuon),children:"Xác nhận trả"}),t.jsx("button",{className:"action-btn",onClick:()=>T(e),children:"Thêm vi phạm"})]})]},e.idCTPM))})]}),o&&t.jsxs("div",{className:"vi-pham-form",children:[t.jsxs("h3",{children:["Thêm vi phạm cho: ",o.tenSach," (ID sách cá biệt: ",o.idSachCaBiet,")"]}),t.jsxs("div",{className:"vipham-buttons",children:[t.jsx("button",{onClick:()=>P("mất sách"),children:"Mất sách"}),t.jsx("button",{onClick:()=>P("hỏng sách nhẹ"),children:"Hỏng sách nhẹ"}),t.jsx("button",{onClick:()=>P("hỏng sách nặng"),children:"Hỏng sách nặng"})]}),t.jsxs("div",{className:"vipham-inputs",children:[t.jsxs("label",{children:[t.jsx("span",{children:"Mô tả:"}),t.jsx("input",{type:"text",value:h.moTa,onChange:e=>u({...h,moTa:e.target.value})})]}),t.jsxs("label",{children:[t.jsx("span",{children:"Hình thức xử lý:"}),t.jsx("input",{type:"text",value:h.hinhThucXuLy,onChange:e=>u({...h,hinhThucXuLy:e.target.value})})]}),t.jsxs("label",{children:[t.jsx("span",{children:"Tiền phạt:"}),t.jsx("input",{type:"text",value:(h.tienPhat*1e3).toLocaleString("vi-VN"),onChange:e=>u({...h,tienPhat:Number(e.target.value)})})]})]}),t.jsx("button",{className:"action-btn",onClick:R,children:"Thêm vi phạm"})]}),t.jsx("button",{className:"action-btn close-btn",onClick:()=>{f(!1),T(null)},children:"Đóng"})]})})]})};export{Q as default};
